"use strict";angular.module("hnlyticsApp",["firebase","ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","angles","ngStorage"]).constant("_",window._).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"TimeOfDayCtrl",resolve:{timeOfDayChart:["chartsService",function(a){return a.timeOfDay()}],subsByPeriod:["subsByPeriodService",function(a){return a.getSubsByPeriod()}]}}).when("/latest",{templateUrl:"views/latest.html",controller:"LatestCtrl as vm",resolve:{activityData:["chartsService",function(a){return a.lastPostActivity()}]}}).when("/toppost",{templateUrl:"views/toppost.html",controller:"TopPostCtrl",resolve:{activityData:["chartsService",function(a){return a.topPostActivity()}]}}).when("/global",{templateUrl:"views/global.html",controller:"AboutCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("hnlyticsApp").controller("MainCtrl",["$scope","$rootScope","UserStatsService",function(a,b,c){function d(){c.results(b.user).then(function(b){return a.userStats=b,a.dgntData=[{label:"Comments",value:b.comments.length,color:"#949FB1"},{label:"Stories",value:b.stories.length,color:"#F7464A"}],b})}a.$on("child:changed",function(a){console.log("===============================",a)}),b.user="pg",a.current=1,a.setCurrent=function(b){a.current=b},d(),a.pullUserData=function(c){b.user=c,d(),a.$broadcast("New User Data",c)}}]),angular.module("hnlyticsApp").controller("LatestCtrl",["$scope","chartsService","activityData",function(a,b,c){a.lastPostChart=c,a.$on("New User Data",function(c,d){subsByPeriodService.getSubsByPeriod().then(function(b){a.subsByPeriod=b}),b.latestPostActivity().then(function(b){a.lastPostChart=b}),console.log("==================DATA",d)})}]),angular.module("hnlyticsApp").controller("TopPostCtrl",["$scope","$firebase","$timeout","$sce","activityData","UserStatsService",function(a,b,c,d,e){a.topPostChart=e}]),angular.module("hnlyticsApp").controller("TimeOfDayCtrl",["$scope","timeOfDayChart","subsByPeriodService","chartsService","subsByPeriod",function(a,b,c,d,e){a.chart=b,a.subsByPeriod=e,a.$on("New User Data",function(b,e){c.getSubsByPeriod().then(function(b){a.subsByPeriod=b}),d.timeOfDay().then(function(b){a.chart=b}),console.log("==================DATA",e)})}]),angular.module("hnlyticsApp").service("UserStatsService",["$firebase","$timeout","$http","getSubsService","$q","$rootScope","$localStorage",function(a,b,c,d,e,f){var g=function(b,c){var e=new Firebase("https://hacker-news.firebaseio.com/v0/"),f=(e.child("item"),e.child("user").child(b)),g=a(f),h=g.$asObject();d.subs(b).then(function(a){h.$loaded().then(function(){var b=a[1],d=a[2],e=a[0],f=b[0],g={},i=0,j=new Date(1e3*h.created),k=document.createElement("div");k.innerHTML=h.about;for(var l=k.textContent||k.innerText,m=_.unescape(l),n=0;n<b.length;n++)b[n].score>i&&(g=b[n],i=b[n].score);var o=Math.round(function(){for(var a=0,b=0;b<e.length;b++)e[b].score?a+=e[b].score:e[b].kids&&(a+=e[b].kids.length);return a/e.length}());c({topPost:g,lastPost:f,average:o,stories:b,comments:d,submissions:e,karma:h.karma,about:m,submitted:h.submitted,createdAt:j.getMonth().toString()+"/"+j.getFullYear().toString()})})})};return{results:function(a){var c=e.defer();return g(a,function(a){b(function(){f.$apply(function(){c.resolve(a)})})}),c.promise}}}]),angular.module("hnlyticsApp").service("getSubsService",["$firebase","$q","$localStorage","$timeout","$rootScope",function(a,b,c,d,e){var f=[],g=[],h=[],i=function(a,d){if(c.user&&c.user.id===e.user)return f=c.user.submissions,g=c.user.stories,h=c.user.comments,console.log("it was in local storage"),void d(f,g,h);if(!c.user){var i=new Firebase("https://hacker-news.firebaseio.com/v0/"),j=i.child("item"),k=i.child("user").child(e.user),l=b.defer();return k.child("submitted").once("value",function(a){var b;a.val().length>1e3?b=1e3:a.val().length<1e3&&(b=a.val().length);for(var c=a.val().slice(0,b),e=0;e<c.length;e++)!function(a){j.child(c[a]).once("value",function(b){if(a===c.length-1){l.resolve({submissions:f,stories:g,comments:h}),d(f,g,h)}null!==b.child("type").val()&&("story"===b.child("type").val()&&(f.push(b.val()),g.push(b.val())),"comment"===b.child("type").val()&&(f.push(b.val()),h.push(b.val())))})}(e)}),l.promise}c.$reset()};return{subs:function(a){var c=b.defer();return i(a,function(a,b,f){var g=[a,b,f];d(function(){e.$apply(function(){c.resolve(g)})})}),c.promise}}}]),angular.module("hnlyticsApp").service("averageTimeOfDayService",["$firebase","$timeout","$http","getSubsService","$q","$rootScope",function(a,b,c,d,e,f){var g=function(){var a=d.subs(f.user).then(function(a){for(var b=(a[1],a[2],a[0]),c=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],d=b.map(function(a){var b=new Date(1e3*a.time);return b.getHours()}).reduce(function(a,b){var c=a[0].indexOf(b);return-1===c?(a[0].push(b),a[1].push(1)):a[1][c]+=1,a},[[],[]]).reduce(function(a,b,c,d){var e=[];return a.forEach(function(a,b){e.push([a,d[1][b]])}),e}),e=0;e<d.length;e++)c[d[e][0]]=d[e][1];return c});return a};return{timesOfTheDay:g}}]),angular.module("hnlyticsApp").directive("leftNav",["$rootScope",function(){return{restrict:"EA",scope:{},controller:["$scope",function(a){a.current=1,a.setCurrent=function(b){a.current=b}}],link:function(){}}}]),angular.module("hnlyticsApp").service("chartsService",["lastPostCommentsService","topPostCommentsService","averageTimeOfDayService",function(a,b,c){var d=function(){var a=c.timesOfTheDay().then(function(a){var b={labels:["midnight","1am","2am","3am","4am","5am","6am","7am","8am","9am","10am","11am","Noon","1pm","2pm","3pm","4pm","5pm","6pm","7pm","8pm","9pm","10pm","11pm"],datasets:[{fillColor:"rgba(151,187,205,0)",strokeColor:"#FF6600",pointColor:"rgba(151,187,205,0)",pointStrokeColor:"#e67e22",data:a}]};return b});return a},e=function(){var b=a.lastPostActivity().then(function(a){for(var b=_.toArray(a),c=[],d=[],e=0;e<b.length;e++)for(var f=b[e].day,g=0;23>g;g++)console.log(f),c.push(f+" "+g),d.push(b[e][g]?b[e][g]:0);console.log(c);var h={labels:c,datasets:[{fillColor:"rgba(151,187,205,0)",strokeColor:"#FF6600",pointColor:"rgba(151,187,205,0)",pointStrokeColor:"#e67e22",data:d}]};return h});return b},f=function(){var a=b.topPostActivity().then(function(a){for(var b=_.toArray(a),c=[],d=[],e=0;e<b.length;e++)for(var f=b[e].day,g=0;23>g;g++)console.log(f),c.push(f+" "+g),d.push(b[e][g]?b[e][g]:0);console.log(c),console.log(d);var h={labels:c,datasets:[{fillColor:"rgba(151,187,205,0)",strokeColor:"#FF6600",pointColor:"rgba(151,187,205,0)",pointStrokeColor:"#e67e22",data:d}]};return h});return a};return{timeOfDay:d,lastPostActivity:e,topPostActivity:f}}]),angular.module("hnlyticsApp").service("lastPostCommentsService",["$firebase","$q","$localStorage","$timeout","$rootScope","$http","getSubsService",function(a,b,c,d,e,f,g){var h=function(a){g.subs(e.user).then(function(b){var c=b[1],e=c[0],f={},g=function(a){function b(c){for(var e=0;e<c.length;e++)c[h]&&!function(e){f.child(c[e]).once("value",function(c){i++,d(function(){return g.push(c.val()),46===e&&47===i?void a(g):void(c.child("kids").val()&&g.length<300&&b(c.child("kids").val()))})})}(h),h++}var c=new Firebase("https://hacker-news.firebaseio.com/v0/"),f=c.child("item"),g=[],h=0,i=0;b(e.kids)},h=function(){g(function(b){for(var c=0;c<b.length;c++)if(b[c].time){var d=new Date(1e3*b[c].time),e=d.getDate(),g=d.getHours();console.log(e,g),f[e]?f[e][g]?f[e][g]++:(f[e][g]=1,console.log(f[e])):(f[e]={day:e},f[e][g]=1)}a(f)})};h()})};return{lastPostActivity:function(){var a=b.defer();return h(function(b){d(function(){console.log(b),e.$apply(function(){a.resolve(b)})})}),a.promise}}}]),angular.module("hnlyticsApp").service("subsByPeriodService",["$firebase","$timeout","$http","getSubsService","$q","$rootScope",function(a,b,c,d,e,f){var g=[],h=[],i=[],j=[],k=[],l=[],m=[],n=function(){var a=d.subs(f.user).then(function(a){var b=(a[1],a[2],a[0]),c=function(a,b){return b===a},d=function(a,b){return b===a},e=function(a,b){return b===a};return g=_.filter(b,function(a){var b=new Date,d=b.getFullYear(),e=new Date(1e3*a.time),f=e.getFullYear();return c(f,d)}),h=_.filter(b,function(a){var b=new Date,d=b.getFullYear()-1,e=new Date(1e3*a.time),f=e.getFullYear();return c(f,d)}),i=_.filter(b,function(a){var b=new Date,c=b.getMonth(),e=new Date(1e3*a.time),f=e.getMonth();return d(f,c)}),j=_.filter(b,function(a){var b=new Date,c=b.getMonth()-1,e=new Date(1e3*a.time),f=e.getMonth();return d(f,c)}),k=_.filter(b,function(a){var b=new Date,c=b.getWeek(),d=new Date(a.time),f=d.getWeek();return e(f,c)}),l=_.filter(b,function(a){var b=new Date,c=b.getWeek()-1,d=new Date(a.time),f=d.getWeek();return e(f,c)}),console.log(m.length),console.log(i.length-j.length/j.length),{thisYearsTot:g.length,lastYearsTot:h.length,thisMonthsTot:i.length,lastMonthsTot:j.length,thisWeeksTot:k.length,lastWeeksTot:l.length,yearsDiff:g.length-h.length/h.length,monthsDiff:i.length-j.length/j.length,weeksDiff:k.length-l.length/l.length}});return a};return{getSubsByPeriod:n}}]),Date.prototype.getWeek=function(a){a="int"==typeof a?a:0;var b=new Date(this.getFullYear(),0,1),c=b.getDay()-a;c=c>=0?c:c+7;var d,e=Math.floor((this.getTime()-b.getTime()-6e4*(this.getTimezoneOffset()-b.getTimezoneOffset()))/864e5)+1;return 4>c?(d=Math.floor((e+c-1)/7)+1,d>52&&(nYear=new Date(this.getFullYear()+1,0,1),nday=nYear.getDay()-a,nday=nday>=0?nday:nday+7,d=4>nday?1:53)):d=Math.floor((e+c-1)/7),d},angular.module("hnlyticsApp").service("topPostCommentsService",["$firebase","$q","$localStorage","$timeout","$rootScope","$http","getSubsService",function(a,b,c,d,e,f,g){var h=function(a){g.subs(e.user).then(function(b){for(var c=b[1],e={},f=0,g=0;g<c.length;g++)c[g].score>f&&(e=c[g],f=c[g].score);var h={},i=function(a){function b(b){for(var c=0,e=0;e<b.length;e++)b[h]&&!function(e){c++,f.child(b[e]).once("value",function(f){d(function(){return g.push(f.val()),c--,e===b.length-1&&0===c?(console.log("end"),void a(g)):void(f.child("kids").val()&&g.length<300)})})}(h),h++}var c=new Firebase("https://hacker-news.firebaseio.com/v0/"),f=c.child("item"),g=[],h=0;b(e.kids)},j=function(){i(function(b){console.log("heyyy");for(var c=0;c<b.length;c++)if(b[c].time){var d=new Date(1e3*b[c].time),e=d.getDate(),f=d.getHours();console.log(e,f),h[e]?h[e][f]?h[e][f]++:(h[e][f]=1,console.log(h[e])):(h[e]={day:e},h[e][f]=1)}a(h)})};j()})};return{topPostActivity:function(){var a=b.defer();return h(function(b){d(function(){console.log(b),e.$apply(function(){a.resolve(b)})})}),a.promise}}}]);